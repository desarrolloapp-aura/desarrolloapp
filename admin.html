<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de AdministraciÃ³n - EvaluaciÃ³n de Proveedores</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-service.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/admin-pdf.js"></script>
    <script>
        // Verificar autenticaciÃ³n antes de cargar la pÃ¡gina
        (function () {
            const isAuthenticated = sessionStorage.getItem('adminAuthenticated') === 'true';

            if (!isAuthenticated) {
                window.location.href = 'login-admin.html';
                return;
            }

            // Limpiar sesiÃ³n cuando el usuario sale de la pÃ¡gina (navegaciÃ³n, retroceso, cierre de pestaÃ±a)
            // sessionStorage se limpia automÃ¡ticamente al cerrar la pestaÃ±a, pero tambiÃ©n lo hacemos explÃ­citamente
            window.addEventListener('beforeunload', function () {
                sessionStorage.removeItem('adminAuthenticated');
                sessionStorage.removeItem('adminAuthTime');
            });
        })();
    </script>
</head>

<body>
    <div class="admin-layout">
        <nav class="admin-sidebar">
            <div class="sidebar-header">
                <h2>Panel Admin</h2>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-item active" data-target="section-general">ï¿½ General</li>
                <li class="menu-item" data-target="section-items-producto">ğŸŸ¦ Ãtems Producto</li>
                <li class="menu-item" data-target="section-items-servicio">ğŸŸ© Ãtems Servicio</li>
                <li class="menu-item" data-target="section-evaluadores">ğŸ‘¥ Evaluadores</li>
                <li class="menu-item" data-target="section-proveedores">ğŸ¢ Proveedores</li>
                <li class="menu-item" data-target="section-asignaciones">ğŸ”— Asignaciones</li>
                <li class="menu-item" data-target="section-evaluaciones">ğŸ“‹ Evaluaciones Guardadas</li>
                <li class="menu-item" data-target="section-pdfs">ğŸ“„ Generar PDFs</li>
                <li class="menu-item menu-item-config-mobile" data-target="section-configuracion">âš™ï¸ ConfiguraciÃ³n</li>
            </ul>
            <div class="sidebar-footer">
                <button id="guardarConfigBtnSidebar" class="btn-save-sidebar">ğŸ’¾ Guardar Todo</button>
                <button id="volverBtn" class="btn-secondary-sidebar">â† Volver al Form</button>
                <button id="cerrarSesionBtn" class="btn-danger-sidebar">ğŸšª Cerrar SesiÃ³n</button>
            </div>
        </nav>

        <main class="admin-main-content">
            <header class="main-header">
                <h1 id="headerTitle">InformaciÃ³n General</h1>
                <p>Gestiona la configuraciÃ³n del sistema de evaluaciÃ³n</p>
            </header>
            
            <!-- MenÃº desplegable mÃ³vil -->
            <div id="menuConfigMobileDropdown" class="menu-config-mobile-dropdown" style="display: none;">
                <button id="guardarTodoMobile" class="menu-config-item">ğŸ’¾ Guardar Todo</button>
                <button id="cambiarPasswordMobile" class="menu-config-item">ğŸ” Cambiar ContraseÃ±a</button>
                <button id="cerrarSesionMobile" class="menu-config-item">ğŸšª Cerrar SesiÃ³n</button>
            </div>

            <div class="content-wrapper">
                <!-- SecciÃ³n: InformaciÃ³n General -->
                <section id="section-general" class="admin-section active-section">
                    <h2>ğŸ“ InformaciÃ³n General</h2>
                    <div class="form-group">
                        <label>TÃ­tulo Principal:</label>
                        <input type="text" id="tituloPrincipal" placeholder="EvaluaciÃ³n de Proveedores">
                    </div>
                    <div class="form-group">
                        <label>DescripciÃ³n de la EvaluaciÃ³n:</label>
                        <textarea id="descripcionEvaluacion" rows="3"
                            placeholder="Este sistema permite evaluar..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Objetivo:</label>
                        <textarea id="objetivoEvaluacion" rows="3"
                            placeholder="Medir y mejorar continuamente..."></textarea>
                    </div>
                </section>

                <!-- SecciÃ³n: Ãtems de PRODUCTO -->
                <section id="section-items-producto" class="admin-section" style="display: none;">
                    <h2>ğŸŸ¦ Ãtems de EvaluaciÃ³n - PRODUCTO</h2>
                    <div id="itemsProductoContainer"></div>
                    <button type="button" id="agregarItemProducto" class="btn-add">+ Agregar Ãtem</button>
                </section>

                <!-- SecciÃ³n: Ãtems de SERVICIO -->
                <section id="section-items-servicio" class="admin-section" style="display: none;">
                    <h2>ğŸŸ© Ãtems de EvaluaciÃ³n - SERVICIO</h2>
                    <div id="itemsServicioContainer"></div>
                    <button type="button" id="agregarItemServicio" class="btn-add">+ Agregar Ãtem</button>
                </section>

                <!-- SecciÃ³n: GestiÃ³n de Evaluadores -->
                <section id="section-evaluadores" class="admin-section" style="display: none;">
                    <h2>ğŸ‘¥ GestiÃ³n de Evaluadores</h2>
                    <div class="form-group">
                        <label>Agregar Nuevo Evaluador:</label>
                        <div class="add-evaluador-container">
                            <input type="text" id="nuevoEvaluador" placeholder="Nombre del evaluador">
                            <button type="button" id="agregarEvaluadorBtn" class="btn-add">+ Agregar Evaluador</button>
                        </div>
                    </div>
                    <div id="evaluadoresList" class="evaluadores-grid"></div>
                </section>

                <!-- SecciÃ³n: GestiÃ³n de Proveedores -->
                <section id="section-proveedores" class="admin-section" style="display: none;">
                    <h2>ğŸ¢ GestiÃ³n de Proveedores</h2>
                    <div class="form-group">
                        <label>Agregar Nuevo Proveedor:</label>
                        <div class="add-proveedor-container">
                            <input type="text" id="nuevoProveedor" placeholder="Nombre del proveedor">
                            <select id="tipoNuevoProveedor">
                                <option value="PRODUCTO">PRODUCTO</option>
                                <option value="SERVICIO">SERVICIO</option>
                            </select>
                            <button type="button" id="agregarProveedorBtn" class="btn-add">+ Agregar Proveedor</button>
                        </div>
                    </div>
                    <div id="proveedoresList" class="proveedores-grid"></div>
                </section>

                <!-- SecciÃ³n: AsignaciÃ³n de Proveedores a Evaluadores -->
                <section id="section-asignaciones" class="admin-section" style="display: none;">
                    <h2>ğŸ”— Asignar Proveedores a Evaluadores</h2>
                    <p class="section-description">Selecciona un evaluador y asigna sus proveedores correspondientes:
                    </p>
                    <div id="asignacionesContainer" class="asignaciones-container"></div>
                </section>

                <!-- SecciÃ³n: Evaluaciones Guardadas -->
                <section id="section-evaluaciones" class="admin-section" style="display: none;">
                    <h2>ğŸ“‹ Evaluaciones Guardadas</h2>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333; font-size: 1.1rem;">ğŸ“… Seleccione el AÃ±o:</label>
                            <select id="filtroAnio" style="width: 100%; max-width: 300px; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 1rem; font-weight: 600;">
                                <option value="">-- Seleccione un aÃ±o --</option>
                            </select>
                        </div>
                        <div id="contenidoAnio" style="display: none; margin-top: 20px;">
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <button type="button" id="descargarAnioCompletoBtn" class="btn-add" style="width: 100%; padding: 12px 20px; font-size: 1rem; white-space: normal; word-wrap: break-word;">ğŸ“¥ DESCARGAR TODO EL AÃ‘O SELECCIONADO</button>
                            </div>
                            <h3 style="margin-bottom: 15px; color: #333;">Evaluaciones Individuales:</h3>
                            <div id="evaluacionesList"></div>
                        </div>
                    </div>
                </section>

                <!-- SecciÃ³n: Generar PDFs -->
                <section id="section-pdfs" class="admin-section" style="display: none;">
                    <h2>ğŸ“„ Generar PDFs de Evaluaciones</h2>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333; font-size: 1.1rem;">ğŸ“… Seleccione el AÃ±o:</label>
                            <select id="filtroAnioPDF" style="width: 100%; max-width: 300px; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 1rem; font-weight: 600;">
                                <option value="">-- Seleccione un aÃ±o --</option>
                            </select>
                        </div>
                        <div id="contenidoAnioPDF" style="display: none; margin-top: 20px;">
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <button type="button" id="descargarPDFAnioCompletoBtn" class="btn-add" style="width: 100%; padding: 12px 20px; font-size: 1rem; white-space: normal; word-wrap: break-word;">ğŸ“¥ DESCARGAR TODOS LOS PDFs DEL AÃ‘O SELECCIONADO</button>
                            </div>
                            <h3 style="margin-bottom: 15px; color: #333;">PDFs Individuales:</h3>
                            <div id="pdfsList"></div>
                        </div>
                    </div>
                </section>

                <!-- SecciÃ³n: ConfiguraciÃ³n (Cambiar contraseÃ±a, etc) -->
                <section id="section-configuracion" class="admin-section" style="display: none;">
                    <h2>âš™ï¸ ConfiguraciÃ³n del Sistema</h2>

                    <!-- SecciÃ³n: Cambiar ContraseÃ±a -->
                    <div class="config-card"
                        style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px solid rgba(102, 126, 234, 0.3); padding: 20px; border-radius: 10px;">
                        <h3>ğŸ” Cambiar ContraseÃ±a de Administrador</h3>
                        <p class="section-description" style="color: #666; margin-bottom: 20px;">Actualiza la contraseÃ±a
                            de acceso al panel de administraciÃ³n</p>
                        <div class="form-group">
                            <label>ContraseÃ±a Actual:</label>
                            <input type="password" id="passwordActual" placeholder="Ingrese su contraseÃ±a actual">
                        </div>
                        <div class="form-group">
                            <label>Nueva ContraseÃ±a:</label>
                            <input type="password" id="nuevaPassword" placeholder="Ingrese la nueva contraseÃ±a">
                        </div>
                        <div class="form-group">
                            <label>Confirmar Nueva ContraseÃ±a:</label>
                            <input type="password" id="confirmarPassword" placeholder="Confirme la nueva contraseÃ±a">
                        </div>
                        <button type="button" id="cambiarPasswordBtn" class="btn-add"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">ï¿½
                            Cambiar ContraseÃ±a</button>
                        <div id="mensajePassword" class="mensaje-exito" style="display: none; margin-top: 15px;"></div>
                    </div>
                </section>

                <!-- SecciÃ³n para mensajes globales -->
                <div id="mensajeGuardado" class="mensaje-exito" style="display: none; margin-top: 20px;"></div>


            </div>
        </main>
    </div>

    <script src="js/admin.js"></script>
    <script>
        // Script para manejar el menÃº mÃ³vil de configuraciÃ³n
        document.addEventListener('DOMContentLoaded', function () {
            const menuConfigDropdown = document.getElementById('menuConfigMobileDropdown');
            const guardarTodoMobile = document.getElementById('guardarTodoMobile');
            const cambiarPasswordMobile = document.getElementById('cambiarPasswordMobile');
            const cerrarSesionMobile = document.getElementById('cerrarSesionMobile');

            // Cerrar menÃº al hacer clic fuera
            if (menuConfigDropdown) {
                document.addEventListener('click', function(e) {
                    if (!menuConfigDropdown.contains(e.target)) {
                        const configMenuItem = document.querySelector('.menu-item-config-mobile');
                        if (configMenuItem && !configMenuItem.contains(e.target)) {
                            menuConfigDropdown.style.display = 'none';
                        }
                    }
                });
            }

            // Guardar Todo
            if (guardarTodoMobile) {
                guardarTodoMobile.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    menuConfigDropdown.style.display = 'none';
                    
                    // Esperar a que las funciones estÃ©n disponibles
                    setTimeout(function() {
                        if (typeof guardarConfiguracionCompleta === 'function') {
                            guardarConfiguracionCompleta();
                        } else if (typeof guardarConfiguracion === 'function') {
                            guardarConfiguracion();
                        } else {
                            // Intentar usar el botÃ³n del sidebar si existe
                            const guardarBtnSidebar = document.getElementById('guardarConfigBtnSidebar');
                            if (guardarBtnSidebar) {
                                guardarBtnSidebar.click();
                            } else {
                                alert('âš ï¸ La funciÃ³n de guardar no estÃ¡ disponible. Por favor, recarga la pÃ¡gina.');
                            }
                        }
                    }, 200);
                });
            }

            // Cambiar ContraseÃ±a - ir a secciÃ³n de configuraciÃ³n
            if (cambiarPasswordMobile) {
                cambiarPasswordMobile.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    menuConfigDropdown.style.display = 'none';
                    
                    // Activar secciÃ³n de configuraciÃ³n
                    setTimeout(function() {
                        const menuItems = document.querySelectorAll('.menu-item');
                        const sections = document.querySelectorAll('.admin-section');
                        const headerTitle = document.getElementById('headerTitle');
                        
                        // Ocultar todas las secciones
                        sections.forEach(section => {
                            section.style.display = 'none';
                            section.classList.remove('active-section');
                        });
                        
                        // Mostrar secciÃ³n de configuraciÃ³n
                        const configSection = document.getElementById('section-configuracion');
                        if (configSection) {
                            configSection.style.display = 'block';
                            configSection.classList.add('active-section');
                        }
                        
                        // Actualizar menÃº activo
                        menuItems.forEach(item => {
                            item.classList.remove('active');
                            if (item.getAttribute('data-target') === 'section-configuracion') {
                                item.classList.add('active');
                            }
                        });
                        
                        // Actualizar tÃ­tulo
                        if (headerTitle) {
                            headerTitle.textContent = 'âš™ï¸ ConfiguraciÃ³n';
                        }
                        
                        // Scroll al inicio
                        window.scrollTo(0, 0);
                    }, 200);
                });
            }

            // Cerrar SesiÃ³n
            if (cerrarSesionMobile) {
                cerrarSesionMobile.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    menuConfigDropdown.style.display = 'none';
                    
                    // Cerrar sesiÃ³n directamente (sin confirmaciÃ³n adicional, el botÃ³n del sidebar ya tiene una)
                    sessionStorage.removeItem('adminAuthenticated');
                    sessionStorage.removeItem('adminAuthTime');
                    window.location.href = 'login-admin.html';
                });
            }
        });

        // Script para manejar la navegaciÃ³n del sidebar
        document.addEventListener('DOMContentLoaded', function () {
            const menuItems = document.querySelectorAll('.menu-item');
            const sections = document.querySelectorAll('.admin-section');
            const headerTitle = document.getElementById('headerTitle');

            // FunciÃ³n para cambiar de secciÃ³n
            function switchSection(targetId, titleText) {
                // Ocultar todas las secciones
                sections.forEach(section => {
                    section.style.display = 'none';
                    section.classList.remove('active-section');
                });

                // Mostrar la secciÃ³n objetivo
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    targetSection.classList.add('active-section');
                    // Scroll al inicio del contenido
                    window.scrollTo(0, 0);
                }

                // Actualizar menÃº activo
                menuItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-target') === targetId) {
                        item.classList.add('active');
                    }
                });

                // Actualizar tÃ­tulo
                if (headerTitle) {
                    headerTitle.textContent = titleText;
                }
            }

            // Event listeners para el menÃº
            menuItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    const target = this.getAttribute('data-target');
                    
                    // En mÃ³viles, si es el item de configuraciÃ³n, abrir el menÃº desplegable
                    if (target === 'section-configuracion' && window.innerWidth <= 900) {
                        e.preventDefault();
                        e.stopPropagation();
                        const menuConfigDropdown = document.getElementById('menuConfigMobileDropdown');
                        if (menuConfigDropdown) {
                            const isVisible = menuConfigDropdown.style.display === 'block';
                            menuConfigDropdown.style.display = isVisible ? 'none' : 'block';
                            return false; // No cambiar de secciÃ³n
                        }
                    }
                    
                    // Obtener texto del tÃ­tulo (sin el icono si se prefiere)
                    let title = this.textContent;
                    switchSection(target, title);
                });
            });

            // Vincular el botÃ³n de guardar del sidebar al botÃ³n original (que puede estar oculto o lo usamos directamente)
            const guardarBtnSidebar = document.getElementById('guardarConfigBtnSidebar');
            if (guardarBtnSidebar) {
                guardarBtnSidebar.addEventListener('click', function () {
                    if (typeof guardarConfiguracion === 'function') {
                        guardarConfiguracion();
                    } else if (typeof guardarConfiguracionCompleta === 'function') {
                        guardarConfiguracionCompleta();
                    } else {
                        console.error('La funciÃ³n guardarConfiguracion no estÃ¡ definida');
                        // Intento de fallback a clickear el botÃ³n original si existe
                        const originalBtn = document.getElementById('guardarConfigBtn');
                        if (originalBtn) originalBtn.click();
                    }
                });
            }
        });
    </script>
</body>

</html>