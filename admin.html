<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Evaluaci√≥n de Proveedores</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-service.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/admin-pdf.js"></script>
    <script>
        // Verificar autenticaci√≥n antes de cargar la p√°gina
        (function () {
            const isAuthenticated = sessionStorage.getItem('adminAuthenticated') === 'true';

            if (!isAuthenticated) {
                window.location.href = 'login-admin.html';
                return;
            }

            // Limpiar sesi√≥n cuando el usuario sale de la p√°gina (navegaci√≥n, retroceso, cierre de pesta√±a)
            // sessionStorage se limpia autom√°ticamente al cerrar la pesta√±a, pero tambi√©n lo hacemos expl√≠citamente
            window.addEventListener('beforeunload', function () {
                sessionStorage.removeItem('adminAuthenticated');
                sessionStorage.removeItem('adminAuthTime');
            });
        })();
    </script>
</head>

<body>
    <div class="admin-layout">
        <nav class="admin-sidebar">
            <div class="sidebar-header">
                <h2>Panel Admin</h2>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-item active" data-target="section-general">ÔøΩ General</li>
                <li class="menu-item" data-target="section-items-producto">üü¶ √çtems Producto</li>
                <li class="menu-item" data-target="section-items-servicio">üü© √çtems Servicio</li>
                <li class="menu-item" data-target="section-evaluadores">üë• Evaluadores</li>
                <li class="menu-item" data-target="section-proveedores">üè¢ Proveedores</li>
                <li class="menu-item" data-target="section-asignaciones">üîó Asignaciones</li>
                <li class="menu-item" data-target="section-evaluaciones">üìã Evaluaciones Guardadas</li>
                <li class="menu-item" data-target="section-pdfs">üìÑ Generar PDFs</li>
                <li class="menu-item menu-item-config-mobile" data-target="section-configuracion">‚öôÔ∏è Configuraci√≥n</li>
            </ul>
            <div class="sidebar-footer">
                <button id="guardarConfigBtnSidebar" class="btn-save-sidebar">üíæ Guardar Todo</button>
                <button id="volverBtn" class="btn-secondary-sidebar">‚Üê Volver al Form</button>
                <button id="cerrarSesionBtn" class="btn-danger-sidebar">üö™ Cerrar Sesi√≥n</button>
            </div>
        </nav>

        <main class="admin-main-content">
            <header class="main-header">
                <h1 id="headerTitle">Informaci√≥n General</h1>
                <p>Gestiona la configuraci√≥n del sistema de evaluaci√≥n</p>
            </header>
            
            <!-- Men√∫ desplegable m√≥vil -->
            <div id="menuConfigMobileDropdown" class="menu-config-mobile-dropdown" style="display: none;">
                <button id="guardarTodoMobile" class="menu-config-item">üíæ Guardar Todo</button>
                <button id="cambiarPasswordMobile" class="menu-config-item">üîê Cambiar Contrase√±a</button>
                <button id="cerrarSesionMobile" class="menu-config-item">üö™ Cerrar Sesi√≥n</button>
            </div>

            <div class="content-wrapper">
                <!-- Secci√≥n: Informaci√≥n General -->
                <section id="section-general" class="admin-section active-section">
                    <h2>üìù Informaci√≥n General</h2>
                    <div class="form-group">
                        <label>T√≠tulo Principal:</label>
                        <input type="text" id="tituloPrincipal" placeholder="Evaluaci√≥n de Proveedores">
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n de la Evaluaci√≥n:</label>
                        <textarea id="descripcionEvaluacion" rows="3"
                            placeholder="Este sistema permite evaluar..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Objetivo:</label>
                        <textarea id="objetivoEvaluacion" rows="3"
                            placeholder="Medir y mejorar continuamente..."></textarea>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                        <h3 style="margin-bottom: 20px; color: #333;">üìÖ Configuraci√≥n de Fechas de la Encuesta</h3>
                        
                        <div class="form-group">
                            <label>A√±o de la Encuesta:</label>
                            <input type="number" id="anioEncuesta" min="2020" max="2100"
                                placeholder="2025" style="width: 200px;">
                            <small style="display: block; color: #666; margin-top: 5px;">
                                Define el a√±o al que corresponde esta encuesta (no se pueden seleccionar a√±os anteriores al actual)
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>Fecha de Inicio (Desde):</label>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <input type="date" id="fechaInicioEncuesta" style="width: 200px;">
                                <input type="time" id="horaInicioEncuesta" style="width: 150px;">
                            </div>
                            <small style="display: block; color: #666; margin-top: 5px;">
                                Fecha y hora desde la cual la encuesta estar√° disponible para los evaluadores
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>Fecha de Fin (Hasta):</label>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <input type="date" id="fechaFinEncuesta" style="width: 200px;">
                                <input type="time" id="horaFinEncuesta" style="width: 150px;">
                            </div>
                            <small style="display: block; color: #666; margin-top: 5px;">
                                Fecha y hora hasta la cual la encuesta estar√° disponible para los evaluadores
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>Zona Horaria:</label>
                            <select id="zonaHorariaEncuesta" style="width: 200px;">
                                <option value="America/Santiago">Chile (Santiago) - UTC-3</option>
                                <option value="America/Mexico_City">M√©xico (Ciudad de M√©xico) - UTC-6</option>
                                <option value="America/Bogota">Colombia (Bogot√°) - UTC-5</option>
                                <option value="America/Lima">Per√∫ (Lima) - UTC-5</option>
                                <option value="America/Buenos_Aires">Argentina (Buenos Aires) - UTC-3</option>
                                <option value="America/Caracas">Venezuela (Caracas) - UTC-4</option>
                                <option value="UTC">UTC (Coordinated Universal Time)</option>
                            </select>
                            <small style="display: block; color: #666; margin-top: 5px;">
                                Seleccione la zona horaria para las fechas de inicio y fin
                            </small>
                        </div>
                        
                        <div id="mensajeFechas" style="display: none; padding: 10px; margin-top: 15px; border-radius: 5px;"></div>
                    </div>
                </section>

                <!-- Secci√≥n: √çtems de PRODUCTO -->
                <section id="section-items-producto" class="admin-section" style="display: none;">
                    <h2>üü¶ √çtems de Evaluaci√≥n - PRODUCTO</h2>
                    <div id="itemsProductoContainer"></div>
                    <button type="button" id="agregarItemProducto" class="btn-add">+ Agregar √çtem</button>
                </section>

                <!-- Secci√≥n: √çtems de SERVICIO -->
                <section id="section-items-servicio" class="admin-section" style="display: none;">
                    <h2>üü© √çtems de Evaluaci√≥n - SERVICIO</h2>
                    <div id="itemsServicioContainer"></div>
                    <button type="button" id="agregarItemServicio" class="btn-add">+ Agregar √çtem</button>
                </section>

                <!-- Secci√≥n: Gesti√≥n de Evaluadores -->
                <section id="section-evaluadores" class="admin-section" style="display: none;">
                    <h2>üë• Gesti√≥n de Evaluadores</h2>
                    <div class="form-group">
                        <label>Agregar Nuevo Evaluador:</label>
                        <div class="add-evaluador-container">
                            <input type="text" id="nuevoEvaluador" placeholder="Nombre del evaluador">
                            <button type="button" id="agregarEvaluadorBtn" class="btn-add">+ Agregar Evaluador</button>
                        </div>
                    </div>
                    <div id="evaluadoresList" class="evaluadores-grid"></div>
                </section>

                <!-- Secci√≥n: Gesti√≥n de Proveedores -->
                <section id="section-proveedores" class="admin-section" style="display: none;">
                    <h2>üè¢ Gesti√≥n de Proveedores</h2>
                    <div class="form-group">
                        <label>Agregar Nuevo Proveedor:</label>
                        <div class="add-proveedor-container">
                            <input type="text" id="nuevoProveedor" placeholder="Nombre del proveedor">
                            <select id="tipoNuevoProveedor">
                                <option value="PRODUCTO">PRODUCTO</option>
                                <option value="SERVICIO">SERVICIO</option>
                            </select>
                            <button type="button" id="agregarProveedorBtn" class="btn-add">+ Agregar Proveedor</button>
                        </div>
                    </div>
                    <div id="proveedoresList" class="proveedores-grid"></div>
                </section>

                <!-- Secci√≥n: Asignaci√≥n de Proveedores a Evaluadores -->
                <section id="section-asignaciones" class="admin-section" style="display: none;">
                    <h2>üîó Asignar Proveedores a Evaluadores</h2>
                    <p class="section-description">Selecciona un evaluador y asigna sus proveedores correspondientes:
                    </p>
                    <div id="asignacionesContainer" class="asignaciones-container"></div>
                </section>

                <!-- Secci√≥n: Evaluaciones Guardadas -->
                <section id="section-evaluaciones" class="admin-section" style="display: none;">
                    <h2>üìã Evaluaciones Guardadas</h2>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333; font-size: 1.1rem;">üìÖ Seleccione el A√±o:</label>
                            <select id="filtroAnio" style="width: 100%; max-width: 300px; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 1rem; font-weight: 600;">
                                <option value="">-- Seleccione un a√±o --</option>
                            </select>
                        </div>
                        <div id="contenidoAnio" style="display: none; margin-top: 20px;">
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <button type="button" id="descargarAnioCompletoBtn" class="btn-add" style="width: 100%; padding: 12px 20px; font-size: 1rem; white-space: normal; word-wrap: break-word;">üì• DESCARGAR TODO EL A√ëO SELECCIONADO</button>
                            </div>
                            <h3 style="margin-bottom: 15px; color: #333;">Evaluaciones Individuales:</h3>
                            <div id="evaluacionesList"></div>
                        </div>
                    </div>
                </section>

                <!-- Secci√≥n: Generar PDFs -->
                <section id="section-pdfs" class="admin-section" style="display: none;">
                    <h2>üìÑ Generar PDFs de Evaluaciones</h2>
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333; font-size: 1.1rem;">üìÖ Seleccione el A√±o:</label>
                            <select id="filtroAnioPDF" style="width: 100%; max-width: 300px; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 1rem; font-weight: 600;">
                                <option value="">-- Seleccione un a√±o --</option>
                            </select>
                        </div>
                        <div id="contenidoAnioPDF" style="display: none; margin-top: 20px;">
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <button type="button" id="descargarPDFAnioCompletoBtn" class="btn-add" style="width: 100%; padding: 12px 20px; font-size: 1rem; white-space: normal; word-wrap: break-word;">üì• DESCARGAR TODOS LOS PDFs DEL A√ëO SELECCIONADO</button>
                            </div>
                            <h3 style="margin-bottom: 15px; color: #333;">PDFs Individuales:</h3>
                            <div id="pdfsList"></div>
                        </div>
                    </div>
                </section>

                <!-- Secci√≥n: Configuraci√≥n (Cambiar contrase√±a, etc) -->
                <section id="section-configuracion" class="admin-section" style="display: none;">
                    <h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>

                    <!-- Secci√≥n: Cambiar Contrase√±a -->
                    <div class="config-card"
                        style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px solid rgba(102, 126, 234, 0.3); padding: 20px; border-radius: 10px;">
                        <h3>üîê Cambiar Contrase√±a de Administrador</h3>
                        <p class="section-description" style="color: #666; margin-bottom: 20px;">Actualiza la contrase√±a
                            de acceso al panel de administraci√≥n</p>
                        <div class="form-group">
                            <label>Contrase√±a Actual:</label>
                            <input type="password" id="passwordActual" placeholder="Ingrese su contrase√±a actual">
                        </div>
                        <div class="form-group">
                            <label>Nueva Contrase√±a:</label>
                            <input type="password" id="nuevaPassword" placeholder="Ingrese la nueva contrase√±a">
                        </div>
                        <div class="form-group">
                            <label>Confirmar Nueva Contrase√±a:</label>
                            <input type="password" id="confirmarPassword" placeholder="Confirme la nueva contrase√±a">
                        </div>
                        <button type="button" id="cambiarPasswordBtn" class="btn-add"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">ÔøΩ
                            Cambiar Contrase√±a</button>
                        <div id="mensajePassword" class="mensaje-exito" style="display: none; margin-top: 15px;"></div>
                    </div>
                </section>

                <!-- Secci√≥n para mensajes globales -->
                <div id="mensajeGuardado" class="mensaje-exito" style="display: none; margin-top: 20px;"></div>


            </div>
        </main>
    </div>

    <script src="js/admin.js"></script>
    <script>
        // Script para manejar el men√∫ m√≥vil de configuraci√≥n
        document.addEventListener('DOMContentLoaded', function () {
            const menuConfigDropdown = document.getElementById('menuConfigMobileDropdown');
            const guardarTodoMobile = document.getElementById('guardarTodoMobile');
            const cambiarPasswordMobile = document.getElementById('cambiarPasswordMobile');
            const cerrarSesionMobile = document.getElementById('cerrarSesionMobile');

            // Cerrar men√∫ al hacer clic fuera
            if (menuConfigDropdown) {
                document.addEventListener('click', function(e) {
                    if (!menuConfigDropdown.contains(e.target)) {
                        const configMenuItem = document.querySelector('.menu-item-config-mobile');
                        if (configMenuItem && !configMenuItem.contains(e.target)) {
                            menuConfigDropdown.style.display = 'none';
                        }
                    }
                });
            }

            // Guardar Todo
            if (guardarTodoMobile) {
                guardarTodoMobile.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    menuConfigDropdown.style.display = 'none';
                    console.log('üíæ Bot√≥n guardar m√≥vil clickeado');
                    
                    try {
                        if (typeof guardarConfiguracionCompleta === 'function') {
                            await guardarConfiguracionCompleta();
                        } else {
                            console.error('La funci√≥n guardarConfiguracionCompleta no est√° definida');
                            alert('Error: No se pudo guardar la configuraci√≥n. Por favor, recargue la p√°gina.');
                        }
                    } catch (error) {
                        console.error('Error al guardar desde m√≥vil:', error);
                        alert('Error al guardar: ' + (error.message || 'Error desconocido'));
                    }
                });
            }

            // Cambiar Contrase√±a - ir a secci√≥n de configuraci√≥n
            if (cambiarPasswordMobile) {
                cambiarPasswordMobile.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    menuConfigDropdown.style.display = 'none';
                    
                    // Activar secci√≥n de configuraci√≥n
                    setTimeout(function() {
                        const menuItems = document.querySelectorAll('.menu-item');
                        const sections = document.querySelectorAll('.admin-section');
                        const headerTitle = document.getElementById('headerTitle');
                        
                        // Ocultar todas las secciones
                        sections.forEach(section => {
                            section.style.display = 'none';
                            section.classList.remove('active-section');
                        });
                        
                        // Mostrar secci√≥n de configuraci√≥n
                        const configSection = document.getElementById('section-configuracion');
                        if (configSection) {
                            configSection.style.display = 'block';
                            configSection.classList.add('active-section');
                        }
                        
                        // Actualizar men√∫ activo
                        menuItems.forEach(item => {
                            item.classList.remove('active');
                            if (item.getAttribute('data-target') === 'section-configuracion') {
                                item.classList.add('active');
                            }
                        });
                        
                        // Actualizar t√≠tulo
                        if (headerTitle) {
                            headerTitle.textContent = '‚öôÔ∏è Configuraci√≥n';
                        }
                        
                        // Scroll al inicio
                        window.scrollTo(0, 0);
                    }, 200);
                });
            }

            // Cerrar Sesi√≥n
            if (cerrarSesionMobile) {
                cerrarSesionMobile.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    menuConfigDropdown.style.display = 'none';
                    
                    // Cerrar sesi√≥n directamente (sin confirmaci√≥n adicional, el bot√≥n del sidebar ya tiene una)
                    sessionStorage.removeItem('adminAuthenticated');
                    sessionStorage.removeItem('adminAuthTime');
                    window.location.href = 'login-admin.html';
                });
            }
        });

        // Script para manejar la navegaci√≥n del sidebar
        document.addEventListener('DOMContentLoaded', function () {
            const menuItems = document.querySelectorAll('.menu-item');
            const sections = document.querySelectorAll('.admin-section');
            const headerTitle = document.getElementById('headerTitle');

            // Funci√≥n para cambiar de secci√≥n
            function switchSection(targetId, titleText) {
                // Ocultar todas las secciones
                sections.forEach(section => {
                    section.style.display = 'none';
                    section.classList.remove('active-section');
                });

                // Mostrar la secci√≥n objetivo
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    targetSection.classList.add('active-section');
                    // Scroll al inicio del contenido
                    window.scrollTo(0, 0);
                }

                // Actualizar men√∫ activo
                menuItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-target') === targetId) {
                        item.classList.add('active');
                    }
                });

                // Actualizar t√≠tulo
                if (headerTitle) {
                    headerTitle.textContent = titleText;
                }
            }

            // Event listeners para el men√∫
            menuItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    const target = this.getAttribute('data-target');
                    
                    // En m√≥viles, si es el item de configuraci√≥n, abrir el men√∫ desplegable
                    if (target === 'section-configuracion' && window.innerWidth <= 900) {
                        e.preventDefault();
                        e.stopPropagation();
                        const menuConfigDropdown = document.getElementById('menuConfigMobileDropdown');
                        if (menuConfigDropdown) {
                            const isVisible = menuConfigDropdown.style.display === 'block';
                            menuConfigDropdown.style.display = isVisible ? 'none' : 'block';
                            return false; // No cambiar de secci√≥n
                        }
                    }
                    
                    // Obtener texto del t√≠tulo (sin el icono si se prefiere)
                    let title = this.textContent;
                    switchSection(target, title);
                });
            });

            // Vincular el bot√≥n de guardar del sidebar al bot√≥n original (que puede estar oculto o lo usamos directamente)
            const guardarBtnSidebar = document.getElementById('guardarConfigBtnSidebar');
            if (guardarBtnSidebar) {
                guardarBtnSidebar.addEventListener('click', async function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üíæ Bot√≥n guardar sidebar clickeado');
                    try {
                        if (typeof guardarConfiguracionCompleta === 'function') {
                            await guardarConfiguracionCompleta();
                        } else {
                            console.error('La funci√≥n guardarConfiguracionCompleta no est√° definida');
                            alert('Error: No se pudo guardar la configuraci√≥n. Por favor, recargue la p√°gina.');
                        }
                    } catch (error) {
                        console.error('Error al guardar desde sidebar:', error);
                        alert('Error al guardar: ' + (error.message || 'Error desconocido'));
                    }
                });
            }
        });
    </script>
</body>

</html>